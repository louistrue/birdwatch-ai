# E2E Testing Stack - Simulates entire birdwatch system without physical hardware

services:
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: test-mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto-test.conf:/mosquitto/config/mosquitto.conf
    networks:
      - test-birdwatch

  # RTSP Server (mediamtx)
  rtsp-server:
    image: bluenviron/mediamtx:latest
    container_name: test-rtsp-server
    ports:
      - "8554:8554"
    networks:
      - test-birdwatch

  # FFmpeg publisher - streams test video to RTSP server
  rtsp-publisher:
    image: linuxserver/ffmpeg:latest
    container_name: test-rtsp-publisher
    depends_on:
      - rtsp-server
    volumes:
      - .:/test-dir:ro
      - ./fixtures/videos:/videos
    entrypoint: /bin/sh
    command: ["-c", "ffmpeg -y -loop 1 -i /test-dir/fixtures/images/great_tit_1.jpg -vf \"scale=1920:1080,crop=1280:720:320+t*10:180+t*5,format=yuv420p\" -c:v libx264 -t 10 -movflags +faststart /videos/bird_test.mp4 && ffmpeg -re -stream_loop -1 -i /videos/bird_test.mp4 -c copy -f rtsp rtsp://rtsp-server:8554/camera1"]
    networks:
      - test-birdwatch

  # Frigate NVR
  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: test-frigate
    privileged: true
    shm_size: '256mb'
    ports:
      - "5052:5000"
    volumes:
      - ./frigate.test.yml:/config/config.yml
      - ./data/test-recordings:/media/frigate
      - ./data/test-snapshots:/media/snapshots
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 500000000
    depends_on:
      - mosquitto
      - rtsp-publisher
    networks:
      - test-birdwatch

  # PostgreSQL Database
  database:
    image: postgres:15-alpine
    container_name: test-db
    environment:
      - POSTGRES_DB=birdwatch_test
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_pass
    volumes:
      - ../database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    networks:
      - test-birdwatch

  # Bird Classifier
  classifier:
    build:
      context: ../classifier
      dockerfile: Dockerfile
    container_name: test-classifier
    volumes:
      - ./data/test-snapshots:/snapshots
      - ../classifier/model:/app/model
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - DB_HOST=database
      - DB_NAME=birdwatch_test
      - DB_USER=test_user
      - DB_PASSWORD=test_pass
      - MODEL_PATH=/app/model/birds_model.tflite
      - CONFIDENCE_THRESHOLD=0.1
    depends_on:
      - mosquitto
      - database
    networks:
      - test-birdwatch

  # Correlator
  correlator:
    build:
      context: ../correlator
      dockerfile: Dockerfile
    container_name: test-correlator
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - DB_HOST=database
      - DB_NAME=birdwatch_test
      - DB_USER=test_user
      - DB_PASSWORD=test_pass
      - CORRELATION_WINDOW=30
    depends_on:
      - mosquitto
      - database
      - classifier
    networks:
      - test-birdwatch

  # Web Dashboard
  web:
    build:
      context: ../web
      dockerfile: Dockerfile
    container_name: test-web
    ports:
      - "8081:8080"
    volumes:
      - ./data/test-snapshots:/app/static/snapshots:ro
    environment:
      - DB_HOST=database
      - DB_NAME=birdwatch_test
      - DB_USER=test_user
      - DB_PASSWORD=test_pass
      - FRIGATE_URL=http://frigate:5000
    depends_on:
      - database
      - frigate
    networks:
      - test-birdwatch

  # Mock Audio Detection Service (simulates BirdNET)
  audio-simulator:
    build:
      context: ./mock-services
      dockerfile: Dockerfile.audio
    container_name: test-audio-simulator
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MIN_INTERVAL=5
      - MAX_INTERVAL=15
    depends_on:
      - mosquitto
    networks:
      - test-birdwatch

  # E2E Test Runner
  test-runner:
    build:
      context: ./e2e
      dockerfile: Dockerfile
    container_name: test-runner
    volumes:
      - ./e2e:/tests
      - ./data:/test-data
      - ./data/test-snapshots:/snapshots
      - ./fixtures:/fixtures:ro
    environment:
      - DB_HOST=database
      - DB_NAME=birdwatch_test
      - DB_USER=test_user
      - DB_PASSWORD=test_pass
      - MQTT_HOST=mosquitto
      - WEB_URL=http://web:8080
      - FRIGATE_URL=http://frigate:5000
    depends_on:
      - web
      - classifier
      - correlator
    networks:
      - test-birdwatch
    command: pytest /tests -v --html=/test-data/report.html

networks:
  test-birdwatch:
    driver: bridge
